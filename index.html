<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Menu Pizze Personalizzabili</title>
    <link rel="icon" href="data:,">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Aggiungi Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --warning-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        --glass-bg: rgba(255, 255, 255, 0.25);
        --glass-border: rgba(255, 255, 255, 0.18);
        --shadow-soft: 0 8px 32px rgba(31, 38, 135, 0.37);
        --shadow-medium: 0 12px 40px rgba(31, 38, 135, 0.5);
        --shadow-strong: 0 16px 50px rgba(31, 38, 135, 0.6);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: 'Segoe UI', 'Roboto', 'Inter', Arial, sans-serif;
        padding-bottom: 120px;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
    }

    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.2) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
        z-index: -1;
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(1deg); }
    }

    .category-header {
        position: sticky;
        top: 0;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        z-index: 1000;
        padding: 20px 0 15px;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        border-bottom: 1px solid var(--glass-border);
        border-radius: 0 0 25px 25px;
        margin: 0 15px;
        width: calc(100% - 30px);
    }

    .category-tabs {
        display: flex;
        overflow-x: auto;
        gap: 16px;
        padding: 0 20px 10px;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .category-tabs::-webkit-scrollbar {
        display: none;
    }

    .category-tab {
        white-space: nowrap;
        padding: 14px 32px;
        border-radius: 50px;
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        border: 1.5px solid var(--glass-border);
        font-weight: 700;
        font-size: 1.1rem;
        box-shadow: var(--shadow-soft);
        letter-spacing: 0.8px;
        color: #2d3748;
        position: relative;
        overflow: hidden;
    }

    .category-tab::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.6s;
    }

    .category-tab:hover::before {
        left: 100%;
    }

    .category-tab:hover {
        background: rgba(255, 255, 255, 0.35);
        border-color: rgba(255, 255, 255, 0.5);
        color: #1a202c;
        box-shadow: var(--shadow-medium);
        transform: translateY(-3px);
    }

    .category-tab.active {
        background: var(--primary-gradient);
        color: #fff;
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: 
            var(--shadow-strong),
            inset 0 2px 4px rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .category-title {
        font-size: 2.8rem;
        margin: 50px 0 25px;
        color: white;
        position: relative;
        padding-bottom: 20px;
        font-weight: 800;
        letter-spacing: 1.5px;
        text-align: center;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .category-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 6px;
        background: var(--secondary-gradient);
        border-radius: 3px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .pizza-card {
        border: none;
        border-radius: 25px;
        overflow: hidden;
        box-shadow: var(--shadow-soft);
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        height: 100%;
        margin-bottom: 30px;
        cursor: pointer;
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--glass-border);
        position: relative;
    }

    .pizza-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
        opacity: 0;
        transition: opacity 0.4s;
    }

    .pizza-card:hover {
        transform: translateY(-15px) scale(1.05);
        box-shadow: var(--shadow-strong);
        border: 1.5px solid rgba(255, 255, 255, 0.4);
    }

    .pizza-card:hover::before {
        opacity: 1;
    }

    .cart-badge {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1050;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--success-gradient);
        color: white;
        box-shadow: var(--shadow-medium);
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        border: 2px solid rgba(255, 255, 255, 0.3);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .cart-badge:hover {
        transform: scale(1.15) rotate(10deg);
        box-shadow: var(--shadow-strong);
    }

    .cart-badge .badge-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--danger-gradient);
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: bold;
        border: 2px solid white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .offcanvas-cart {
        width: 450px;
        background: var(--glass-bg);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        border-left: 1px solid var(--glass-border);
    }

    .pizza-modal-img {
        max-height: 250px;
        object-fit: cover;
        border-radius: 20px;
        box-shadow: var(--shadow-soft);
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .cart-item {
        border-bottom: 2px dashed rgba(255, 255, 255, 0.3);
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        margin-bottom: 10px;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }

    .cart-item:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(5px);
    }

    .btn-primary, .btn-success {
        border-radius: 50px;
        padding: 12px 35px;
        font-size: 1.1rem;
        font-weight: 600;
        border: none;
        background: var(--primary-gradient);
        box-shadow: var(--shadow-soft);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .btn-success {
        background: var(--success-gradient);
    }

    .btn-primary::before, .btn-success::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.5s;
    }

    .btn-primary:hover::before, .btn-success:hover::before {
        left: 100%;
    }

    .btn-primary:hover, .btn-success:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-medium);
    }

    .btn-outline-danger {
        border-radius: 50%;
        padding: 0.4em 0.7em;
        border: 2px solid;
        background: transparent;
        transition: all 0.3s ease;
    }

    .btn-outline-danger:hover {
        background: var(--danger-gradient);
        transform: scale(1.1) rotate(90deg);
    }

    /* Resto del CSS mantenendo lo stesso livello di dettaglio... */

    .allergen-indicator {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: var(--danger-gradient);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(255, 0, 0, 0.5);
        border: 2px solid #ffffff;
        z-index: 10;
        animation: pulse-red 1.5s infinite;
    }

    .beverages-button, .allergens-button {
        position: fixed;
        right: 30px;
        z-index: 1060;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        box-shadow: var(--shadow-medium);
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        border: 2px solid rgba(255, 255, 255, 0.3);
        font-size: 1.4rem;
    }

    .beverages-button {
        bottom: 120px;
        background: var(--secondary-gradient);
    }

    .allergens-button {
        bottom: 210px;
        background: var(--warning-gradient);
    }

    .beverages-button:hover, .allergens-button:hover {
        transform: scale(1.15) rotate(12deg);
        box-shadow: var(--shadow-strong);
    }

    /* Animazioni aggiuntive */
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .pizza-card {
        animation: slideInUp 0.6s ease-out;
    }

    /* Effetti di luce */
    .glow {
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
    }

    /* Scrollbar personalizzata */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary-gradient);
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--secondary-gradient);
    }
</style>
</head>
<body>
    <!-- Pulsante bevande fisso -->
    <button class="beverages-button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasBeverages" title="Menu Bevande">
        <i class="bi bi-cup-straw"></i>
    </button>

    <!-- Pulsante allergeni fisso - POSIZIONATO SOPRA IL CARRELLO -->
    <div class="allergens-button" data-bs-toggle="modal" data-bs-target="#allergensModal">
        <i class="bi bi-exclamation-triangle"></i>
    </div>

    <!-- Carrello fisso -->
    <div class="cart-badge" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCart">
        <i class="bi bi-cart3"></i>
        <span class="badge-count" id="cartCounter">0</span>
    </div>

    <!-- Offcanvas Carrello -->
    <div class="offcanvas offcanvas-end offcanvas-cart" tabindex="-1" id="offcanvasCart">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Il tuo ordine</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div class="order-info">
                <!-- Selettore carte da briscola per il tavolo -->
                <div class="card-selector">
                    <div class="card-selector-title">üÉè Seleziona il tavolo con le carte</div>
                    
                    <!-- Selettore semi -->
                    <div class="suit-selector">
                        <div class="suit-btn" data-suit="coppe" title="Coppe">
                            <div class="suit-icon">üèÜ</div>
                            <div class="suit-name">Coppe</div>
                        </div>
                        <div class="suit-btn" data-suit="denari" title="Denari">
                            <div class="suit-icon">üí∞</div>
                            <div class="suit-name">Denari</div>
                        </div>
                        <div class="suit-btn" data-suit="spade" title="Spade">
                            <div class="suit-icon">‚öîÔ∏è</div>
                            <div class="suit-name">Spade</div>
                        </div>
                        <div class="suit-btn" data-suit="bastoni" title="Bastoni">
                            <div class="suit-icon">ü™µ</div>
                            <div class="suit-name">Bastoni</div>
                        </div>
                    </div>
                    
                    <!-- Selettore numeri -->
                    <div class="number-selector">
                        <div class="number-btn disabled" data-number="asso">1</div>
                        <div class="number-btn disabled" data-number="2">2</div>
                        <div class="number-btn disabled" data-number="3">3</div>
                        <div class="number-btn disabled" data-number="4">4</div>
                        <div class="number-btn disabled" data-number="5">5</div>
                        <div class="number-btn disabled" data-number="6">6</div>
                        <div class="number-btn disabled" data-number="7">7</div>
                        <div class="number-btn disabled" data-number="fante">8</div>
                        <div class="number-btn disabled" data-number="cavallo">9</div>
                        <div class="number-btn disabled" data-number="re">10</div>
                    </div>
                    
                    <!-- Display carta selezionata -->
                    <div class="selected-card-display empty" id="selectedCardDisplay">
                        Seleziona prima il seme, poi il numero
                    </div>
                    
                    <!-- Campo nascosto per memorizzare il valore -->
                    <input type="hidden" id="orderName" required>
                </div>
                
                <div class="mb-3">
                    <label for="waiterNumber" class="form-label">üë§ Nome Ordinazione</label>
                    <input type="text" class="form-control" id="waiterNumber" placeholder="Es: Mario Rossi" required>
                    <small class="form-text text-muted">Inserisci Nome Ordinazione</small>
                </div>
            </div>
            
            <div id="cartItems"></div>
            
            <div class="firebase-status" id="firebaseStatus"></div>
            
            <div class="mt-3 pt-3 border-top">
                <h5>Totale pizze: <span id="cartTotal">0.00</span>‚Ç¨</h5>
                <div class="coperto-info">
                    Coperto: <span id="copertoCount">0</span> pizze √ó 2.00‚Ç¨ = <span class="coperto-price" id="copertoTotal">0.00</span>‚Ç¨
                </div>
                <h5 class="total-with-coperto mt-2">Totale con coperto: <span id="totalWithCoperto">0.00</span>‚Ç¨</h5>
                <button class="btn btn-success w-100 mt-3" id="checkoutBtn" disabled>Conferma ordine</button>
            </div>
        </div>
    </div>

    <!-- Offcanvas Bevande -->
    <div class="offcanvas offcanvas-end offcanvas-beverages" tabindex="-1" id="offcanvasBeverages">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title"><i class="bi bi-cup-straw"></i> Menu Bevande</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div id="beveragesContent">
                <div class="text-center text-muted py-4">
                    <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
                    <p class="mt-2">Caricamento bevande...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pizza -->
    <div class="modal fade" id="pizzaModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pizzaModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <img src="" id="pizzaModalImage" class="img-fluid pizza-modal-img mb-3" alt="Pizza">
                            <div id="pizzaAllergens" class="allergen-list"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Ingredienti base:</h6>
                            <p id="pizzaModalBaseIngredients"></p>
                            
                            <div class="mt-3">
                                <label for="pizzaQuantity" class="form-label">Quantit√†:</label>
                                <input type="number" min="1" value="1" class="form-control" id="pizzaQuantity">
                            </div>
                            
                            <!-- Sezione selezione impasti -->
                            <div class="dough-section mt-3">
                                <h6 class="mb-3"><i class="bi bi-circle"></i> Scegli il tipo di impasto:</h6>
                                <div id="doughOptions">
                                    <div class="dough-option selected" data-dough="normale" data-price="0">
                                        <input type="radio" name="doughType" value="normale" checked>
                                        <span>Impasto Normale (preselezionato)</span>
                                        <span class="dough-price">Incluso</span>
                                    </div>
                                    <div class="dough-option" data-dough="proteico" data-price="2.00">
                                        <input type="radio" name="doughType" value="proteico">
                                        <span>Impasto Proteico</span>
                                        <span class="dough-price extra">+2.00‚Ç¨</span>
                                    </div>
                                    <div class="dough-option" data-dough="carbone" data-price="2.00">
                                        <input type="radio" name="doughType" value="carbone">
                                        <span>Impasto al Carbone</span>
                                        <span class="dough-price extra">+2.00‚Ç¨</span>
                                    </div>
                                    <div class="dough-option" data-dough="tirato" data-price="2.00">
                                        <input type="radio" name="doughType" value="tirato">
                                        <span>Impasto Tirato (36 cm)</span>
                                        <span class="dough-price extra">+2.00‚Ç¨</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ingredient-list" id="ingredientList">
                                <!-- Lista ingredienti modificabili -->
                            </div>
                            
                            <button class="btn btn-outline-primary add-ingredients-btn" id="showAdditionsBtn">
                                <i class="bi bi-plus-circle"></i> Aggiungi ingredienti
                            </button>
                            
                            <h5 class="mt-3">Prezzo base: <span id="pizzaModalBasePrice">0.00</span>‚Ç¨</h5>
                            <h5>Extra: <span id="pizzaModalExtraPrice">0.00</span>‚Ç¨</h5>
                            <h4 class="text-primary">Totale: <span id="pizzaModalTotalPrice">0.00</span>‚Ç¨</h4>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-primary" id="addToCartBtn">Aggiungi al carrello</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Aggiunte -->
    <div class="modal fade additions-modal" id="additionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Aggiungi ingredienti</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="additionsList">
                    <!-- Lista ingredienti disponibili -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-primary" id="confirmAdditionsBtn">Conferma</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Allergeni -->
    <div class="modal fade" id="allergensModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gestione Allergeni</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Seleziona i numeri corrispondenti ai tuoi allergeni. Le pizze contenenti questi allergeni saranno evidenziate in rosso.
                    </div>
                    
                    <h5 class="mb-3">Seleziona i tuoi allergeni:</h5>
                    <div class="d-flex flex-wrap justify-content-center mb-4">
                        <button class="btn btn-primary allergen-btn" data-allergen="1">1</button>
                        <button class="btn btn-primary allergen-btn" data-allergen="2">2</button>
                        <button class="btn btn-primary allergen-btn" data-allergen="3">3</button>
                        <button class="btn btn-primary allergen-btn" data-allergen="4">4</button>
                        <button class="btn btn-primary allergen-btn" data-allergen="5">5</button>
                        <button class="btn btn-primary allergen-btn" data-allergen="6">6</button>
                        <button class="btn btn-primary allergen-btn" data-allergen="7">7</button>
                        <button class="btn btn-primary allergen-btn" data-allergen="8">8</button>
                        <button class="btn btn-primary allergen-btn" data-allergen="9">9</button>
                        <button class="btn btn-primary allergen-btn" data-allergen="10">10</button>
                        <button class="btn btn-primary allergen-btn" data-allergen="11">11</button>
                        <button class="btn btn-primary allergen-btn" data-allergen="12">12</button>
                        <button class="btn btn-primary allergen-btn" data-allergen="13">13</button>
                    </div>
                    
                    <div class="text-center mb-4">
                        <button class="btn btn-success me-2" id="applyAllergensBtn">Applica selezione</button>
                        <button class="btn btn-outline-secondary" id="clearAllergensBtn">Cancella tutto</button>
                    </div>
                    
                    <div class="selected-allergens">
                        <h5><i class="bi bi-check2-circle"></i> Allergeni selezionati:</h5>
                        <div id="selectedAllergensList">Nessun allergene selezionato</div>
                    </div>
                    
                    <hr>
                    
                    <h5 class="mb-3">Legenda allergeni:</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-group">
                                <li class="list-group-item">1 - Glutine (cereali, frumento, segale, orzo, avena)</li>
                                <li class="list-group-item">2 - Crostacei e derivati</li>
                                <li class="list-group-item">3 - Uova e derivati</li>
                                <li class="list-group-item">4 - Pesce e derivati</li>
                                <li class="list-group-item">5 - Arachidi e derivati</li>
                                <li class="list-group-item">6 - Soia e derivati</li>
                                <li class="list-group-item">7 - Latte e derivati (incluso lattosio)</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-group">
                                <li class="list-group-item">8 - Frutta a guscio (mandorle, nocciole, noci, ecc.)</li>
                                <li class="list-group-item">9 - Sedano e derivati</li>
                                <li class="list-group-item">10 - Senape e derivati</li>
                                <li class="list-group-item">11 - Semi di sesamo e derivati</li>
                                <li class="list-group-item">12 - Anidride solforosa e solfiti</li>
                                <li class="list-group-item">13 - Lupini e derivati</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container principale -->
    <div class="container py-4">
        <header class="text-center mb-5">
            <h1 class="display-4 fw-bold">üçï Menu Pizze</h1>
            <p class="lead text-muted">Personalizza la tua pizza preferita</p>
        </header>

        <div class="category-header">
            <div class="category-tabs" id="categoryFilters"></div>
        </div>

        <div id="pizzaSections"></div>
    </div>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCNDrS5kB8XnUcV8HHN9dt5f_mUWXYbGJs",
            authDomain: "final-3a252.firebaseapp.com",
            projectId: "final-3a252",
            storageBucket: "final-3a252.firebasestorage.app",
            messagingSenderId: "414588792299",
            appId: "1:414588792299:web:e84177169978ac0792bdae",
            measurementId: "G-NVGWXSB8SW"
        };
        
        // Inizializza Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Stato globale
        let currentPizza = null;
        let cart = [];
        let currentModifications = {
            removed: [],
            added: []
        };
        let selectedAdditions = [];
        let userAllergens = [];
        let selectedDough = {
            type: 'normale',
            price: 0
        };

        // Elementi DOM
        const cartCounter = document.getElementById('cartCounter');
        const cartItemsEl = document.getElementById('cartItems');
        const cartTotalEl = document.getElementById('cartTotal');
        const copertoCountEl = document.getElementById('copertoCount');
        const copertoTotalEl = document.getElementById('copertoTotal');
        const totalWithCopertoEl = document.getElementById('totalWithCoperto');
        const addToCartBtn = document.getElementById('addToCartBtn');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const orderNameInput = document.getElementById('orderName');
        const waiterNumberInput = document.getElementById('waiterNumber');
        const ingredientListEl = document.getElementById('ingredientList');
        const showAdditionsBtn = document.getElementById('showAdditionsBtn');
        const additionsListEl = document.getElementById('additionsList');
        const confirmAdditionsBtn = document.getElementById('confirmAdditionsBtn');
        const firebaseStatusEl = document.getElementById('firebaseStatus');
        const applyAllergensBtn = document.getElementById('applyAllergensBtn');
        const clearAllergensBtn = document.getElementById('clearAllergensBtn');
        const selectedAllergensList = document.getElementById('selectedAllergensList');

        // Elementi per il selettore carte
        let selectedSuit = null;
        let selectedNumber = null;
        const suitIcons = {
            'coppe': 'üèÜ',
            'denari': 'üí∞',
            'spade': '‚öîÔ∏è',
            'bastoni': 'ü™µ'
        };
        const suitNames = {
            'coppe': 'Coppe',
            'denari': 'Denari',
            'spade': 'Spade',
            'bastoni': 'Bastoni'
        };

        // Dati delle pizze con relativi allergeni
        const pizzaMenu = [
            {
                name: "Margherita",
                ingredients: "Pomodoro, mozzarella, basilico",
                price: 6.50,
                allergens: [1, 7],
                categoria: "Classiche"
            },
            {
                name: "Marinara",
                ingredients: "Pomodoro, aglio, origano",
                price: 5.00,
                allergens: [1],
                categoria: "Classiche"
            },
            {
                name: "Diavola",
                ingredients: "Pomodoro, mozzarella, salame piccante",
                price: 8.00,
                allergens: [1, 7],
                categoria: "Classiche"
            },
            {
                name: "Quattro Stagioni",
                ingredients: "Pomodoro, mozzarella, funghi, prosciutto, carciofi, olive",
                price: 9.50,
                allergens: [1, 7],
                categoria: "Speciali"
            },
            {
                name: "Capricciosa",
                ingredients: "Pomodoro, mozzarella, funghi, prosciutto, carciofi, olive",
                price: 9.00,
                allergens: [1, 3, 7],
                categoria: "Speciali"
            },
            {
                name: "Quattro Formaggi",
                ingredients: "Mozzarella, gorgonzola, parmigiano, fontina",
                price: 10.00,
                allergens: [1, 7],
                categoria: "Formaggi"
            },
            {
                name: "Ortolana",
                ingredients: "Pomodoro, mozzarella, melanzane, zucchine, peperoni",
                price: 8.50,
                allergens: [1, 7],
                categoria: "Vegetariane"
            },
            {
                name: "Tonno e Cipolla",
                ingredients: "Pomodoro, mozzarella, tonno, cipolla",
                price: 9.00,
                allergens: [1, 4, 7],
                categoria: "Di Mare"
            },
            {
                name: "Siciliana",
                ingredients: "Pomodoro, mozzarella, acciughe, olive, capperi",
                price: 9.50,
                allergens: [1, 4, 7],
                categoria: "Di Mare"
            },
            {
                name: "Bianca con Ricotta",
                ingredients: "Mozzarella, ricotta, salsiccia",
                price: 10.50,
                allergens: [1, 7],
                categoria: "Speciali"
            }
        ];

        // Funzione per mostrare lo stato di Firebase
        function showFirebaseStatus(message, type) {
            firebaseStatusEl.textContent = message;
            firebaseStatusEl.className = 'firebase-status status-' + type;
            firebaseStatusEl.style.display = 'block';
            
            if (type !== 'loading') {
                setTimeout(() => {
                    firebaseStatusEl.style.display = 'none';
                }, 5000);
            }
        }

        // Controlla i campi obbligatori
        function checkOrderFields() {
            const hasItems = cart.length > 0;
            const hasName = orderNameInput.value.trim() !== '';
            const hasWaiterNumber = waiterNumberInput.value.trim() !== '';
            checkoutBtn.disabled = !(hasItems && hasName && hasWaiterNumber);
        }

        // Event listeners per i campi obbligatori
        orderNameInput.addEventListener('input', checkOrderFields);
        waiterNumberInput.addEventListener('input', checkOrderFields);

        // Funzione per convertire CSV in array di oggetti - CORRETTA
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            const headers = lines[0].split(';').map(h => h.trim().toLowerCase());
            
            return lines.slice(1).map(line => {
                const values = line.split(';');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                });
                return obj;
            });
        }

        // Carica aggiunte da Firestore (collezione 'Add')
        async function loadAdditionsFromFirestore() {
            try {
                showFirebaseStatus('Carico aggiunte...', 'loading');
                const snap = await db.collection('Add').get();
                const additions = [];
                snap.forEach(doc => {
                    const d = doc.data() || {};
                    const usable = d.usable === true || (typeof d.usable === 'string' && d.usable.toLowerCase() === 'true');
                    const name = (d.item || doc.id || '').toString().trim();
                    const priceNum = parseFloat(d.price);
                    const price = isNaN(priceNum) ? 0 : priceNum;
                    if (name) additions.push({ ingredient: name, price, usable });
                });
                additions.sort((a, b) => a.ingredient.localeCompare(b.ingredient, 'it', { sensitivity: 'base' }));
                window.__allAdditions = additions;
                showFirebaseStatus(`Aggiunte caricate: ${additions.length}`, 'success');
            } catch (e) {
                console.error('Errore caricamento aggiunte:', e);
                showFirebaseStatus('Errore caricamento aggiunte: ' + e.message, 'error');
                window.__allAdditions = [];
            }
        }

        // Funzione per caricare le bevande da CSV (prima da GitHub, poi locale)
        async function loadBeveragesFromCSV() {
            const githubUrl = 'https://raw.githubusercontent.com/Rmamavvomvvone/Sito-Pizzeria.github.io/main/birre.csv';
            const localUrl = './birre.csv';
            
            try {
                // Prova prima a caricare da GitHub
                console.log('Tentativo di caricamento bevande da GitHub...');
                let response = await fetch(githubUrl);
                
                if (!response.ok) {
                    // Se GitHub fallisce, prova in locale
                    console.warn('GitHub non disponibile, provo caricamento locale...');
                    response = await fetch(localUrl);
                    
                    if (!response.ok) {
                        console.warn("File birre.csv non trovato n√© su GitHub n√© in locale");
                        return [];
                    }
                    console.log('Bevande caricate da file locale');
                } else {
                    console.log('Bevande caricate da GitHub');
                }
                
                const csvText = await response.text();
                const beverages = parseCSV(csvText);
                
                // Assicurati che ogni bevanda abbia un id univoco e il flag isBeverage
                beverages.forEach((item, idx) => {
                    if (!item.id || item.id === '') {
                        item.id = `beverage_${item.nome}_${item.categoria}_${idx}`;
                    }
                    item.isBeverage = true; // Flag per identificare le bevande
                    // Per le bevande, normalizza descrizione/ingredienti
                    if (!item.descrizione && item.ingredienti) {
                        item.descrizione = item.ingredienti;
                    }
                    if (!item.ingredienti && item.descrizione) {
                        item.ingredienti = item.descrizione;
                    }
                    // Se non c'√® n√© descrizione n√© ingredienti, usa una stringa vuota
                    if (!item.descrizione) {
                        item.descrizione = '';
                    }
                    if (!item.ingredienti) {
                        item.ingredienti = '';
                    }
                });
                
                console.log(`Caricate ${beverages.length} bevande`);
                return beverages;
            } catch (error) {
                console.warn("Errore nel caricamento delle bevande:", error);
                return [];
            }
        }

        // Funzione per generare il menu da CSV
        async function loadMenuFromCSV() {
            try {
                // Carica pizze
                const pizzeResponse = await fetch('./menu_pizze.csv');
                if (!pizzeResponse.ok) throw new Error("Errore nel caricamento del CSV delle pizze");
                const pizzeText = await pizzeResponse.text();
                const pizzeItems = parseCSV(pizzeText);
                
                // Assicurati che ogni pizza abbia un id univoco
                pizzeItems.forEach((item, idx) => {
                    if (!item.id || item.id === '') {
                        item.id = `${item.nome}_${item.categoria}_${idx}`;
                    }
                    item.isBeverage = false; // Flag per identificare le pizze
                });
                
                // Carica bevande
                const beverages = await loadBeveragesFromCSV();
                
                // Estrai categorie solo dalle pizze (non dalle bevande)
                const pizzaCategories = [...new Set(pizzeItems.map(item => item.categoria))];
                
                // Estrai tutti gli ingredienti unici per il menu a tendina
                await loadAdditionsFromFirestore();
                
                // Salva menuItems globalmente per uso in altre funzioni
                window.menuItems = [...pizzeItems, ...beverages];
                window.pizzeItems = pizzeItems;
                window.beverageItems = beverages;

                // Genera la sezione bevande fissa in alto
                renderBeveragesSection(beverages);
                
                // Genera i filtri e le sezioni delle pizze
                renderCategoryFilters(pizzaCategories);
                renderPizzaSections(pizzeItems, pizzaCategories);
                
            } catch (error) {
                console.error("Errore:", error);
                document.getElementById('pizzaSections').innerHTML = `
                    <div class="alert alert-danger">
                        Errore nel caricamento del menu. Verifica che:
                        <ul>
                            <li>Il file menu_pizze.csv esista</li>
                            <li>Il formato del CSV sia corretto</li>
                            <li>La struttura contenga le colonne: nome, prezzo, ingredienti, categoria</li>
                        </ul>
                        Dettaglio errore: ${error.message}
                    </div>
                `;
            }
        }

        // Genera il menu bevande nell'offcanvas
        function renderBeveragesSection(beverages) {
            const beveragesContainer = document.getElementById('beveragesContent');
            
            if (!beverages || beverages.length === 0) {
                beveragesContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-cup-straw-x" style="font-size: 2rem;"></i>
                        <p class="mt-2">Nessuna bevanda disponibile</p>
                    </div>
                `;
                return;
            }
            
            // Raggruppa bevande per categoria
            const beverageCategories = [...new Set(beverages.map(item => item.categoria))];
            
            let html = '';
            
            beverageCategories.forEach(category => {
                const categoryBeverages = beverages.filter(item => item.categoria === category);
                
                html += `<div class="beverage-category-header">
                    <i class="bi bi-cup-straw"></i>
                    <span>${category}</span>
                </div>`;
                
                categoryBeverages.forEach(beverage => {
                    const allergens = beverage.allergeni ? beverage.allergeni.split(',').map(a => parseInt(a.trim())).filter(a => !isNaN(a)) : [];
                    const description = beverage.descrizione || beverage.ingredienti || '';
                    
                    html += `
                        <div class="beverage-item ${allergens.length > 0 ? 'allergen-warning' : ''}" data-beverage-id="${beverage.id}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="beverage-name">${beverage.nome}</div>
                                    ${description ? `<div class="beverage-description">${description}</div>` : ''}
                                    ${allergens.length > 0 ? `<div class="mt-2">${getAllergenBadges(allergens)}</div>` : ''}
                                </div>
                                <div class="beverage-price ms-3">${parseFloat(beverage.prezzo).toFixed(2)}‚Ç¨</div>
                            </div>
                        </div>
                    `;
                });
            });
            
            beveragesContainer.innerHTML = html;
            
            // Aggiungi event listener per ogni bevanda
            beverages.forEach(beverage => {
                const item = beveragesContainer.querySelector(`[data-beverage-id="${beverage.id}"]`);
                if (item) {
                    item.addEventListener('click', () => {
                        addBeverageToCart(beverage);
                        // Chiudi l'offcanvas dopo l'aggiunta (opzionale)
                        // const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasBeverages'));
                        // if (offcanvas) offcanvas.hide();
                    });
                }
            });
        }

        // Genera i filtri delle categorie
        function renderCategoryFilters(categories) {
            const filtersContainer = document.getElementById('categoryFilters');
            filtersContainer.innerHTML = '';
            
            // Filtro "Tutte"
            const allFilter = document.createElement('div');
            allFilter.className = 'category-tab active';
            allFilter.textContent = 'Tutte';
            allFilter.onclick = () => showAllCategories();
            filtersContainer.appendChild(allFilter);
            
            // Filtri per categoria
            categories.forEach(category => {
                const filter = document.createElement('div');
                filter.className = 'category-tab';
                filter.textContent = category;
                filter.onclick = () => filterByCategory(category);
                filtersContainer.appendChild(filter);
            });
        }

        // Genera le sezioni delle pizze e bevande
        function renderPizzaSections(menuItems, categories) {
            const sectionsContainer = document.getElementById('pizzaSections');
            sectionsContainer.innerHTML = '';
            
            categories.forEach(category => {
                const categoryItems = menuItems.filter(item => item.categoria === category);
                
                if (categoryItems.length > 0) {
                    const section = document.createElement('section');
                    section.className = 'category-section';
                    section.id = `cat-${category.replace(/\s+/g, '-')}`;
                    
                    const title = document.createElement('h2');
                    title.className = 'category-title';
                    title.textContent = category;
                    section.appendChild(title);
                    
                    const row = document.createElement('div');
                    row.className = 'row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4';
                    
                    categoryItems.forEach(item => {
                        const col = document.createElement('div');
                        col.className = 'col';
                        
                        // Allergeni direttamente dall'item corrente
                        const allergens = item.allergeni ? item.allergeni.split(',').map(a => parseInt(a.trim())).filter(a => !isNaN(a)) : [];
                        
                        // Determina se √® una bevanda o una pizza
                        const isBeverage = item.isBeverage === true;
                        
                        // Per le bevande mostra la descrizione, per le pizze gli ingredienti
                        let description = '';
                        if (isBeverage) {
                            description = item.descrizione || item.ingredienti || '';
                        } else {
                            const ingredients = item.ingredienti || '';
                            const ingredientList = ingredients.split(',').map(ing => ing.trim()).filter(ing => ing);
                            description = `<span style="font-size: 0.75rem; display: block; line-height: 1.3;">${ingredientList.join('<br>')}</span>`;
                        }
                        
                        col.innerHTML = `
                            <div class="card pizza-card h-100" data-item-name="${item.nome}">
                            
                                <div class="card-body">
                                    <h3 class="h5 card-title">${item.nome}</h3>
                                    <div class="text-danger fw-bold mb-2">${parseFloat(item.prezzo).toFixed(2)}‚Ç¨</div>
                                    <p class="card-text text-muted">
                                        ${description}
                                    </p>
                                    ${allergens.length > 0 ? `<div class="allergen-badges">${getAllergenBadges(allergens)}</div>` : ''}
                                </div>
                            </div>
                        `;
                        
                        // Se √® una bevanda, aggiungi direttamente al carrello, altrimenti mostra i dettagli
                        if (isBeverage) {
                            col.querySelector('.pizza-card').addEventListener('click', () => addBeverageToCart(item));
                        } else {
                            col.querySelector('.pizza-card').addEventListener('click', () => showPizzaDetails(item));
                        }
                        row.appendChild(col);
                    });
                    
                    section.appendChild(row);
                    sectionsContainer.appendChild(section);
                }
            });
            
            // Applica l'evidenziazione allergeni dopo aver renderizzato le pizze
            highlightPizzasWithAllergens();
        }

        // Genera i badge degli allergeni
        function getAllergenBadges(allergens) {
            if (allergens.length === 0) return '';
            
            return allergens
                .sort((a, b) => a - b)
                .map(a => `<span class="allergen-badge">${a}</span>`)
                .join('');
        }

        // Mostra dettagli pizza e gestione ingredienti
        function showPizzaDetails(pizza) {
            currentPizza = pizza;
            currentModifications = { removed: [], added: [] };
            selectedAdditions = [];
            
            // Determina l'impasto originale della pizza
            const originalIngredients = pizza.ingredienti.split(',').map(i => i.trim());
            const originalDough = originalIngredients.find(ingredient => 
                ingredient.toLowerCase().startsWith('impasto')
            );
            
            // Mappa l'impasto originale al tipo corretto
            let defaultDoughType = 'normale';
            if (originalDough) {
                if (originalDough.toLowerCase().includes('proteico')) {
                    defaultDoughType = 'proteico';
                } else if (originalDough.toLowerCase().includes('carbone')) {
                    defaultDoughType = 'carbone';
                } else if (originalDough.toLowerCase().includes('tirato')) {
                    defaultDoughType = 'tirato';
                }
            }
            
            // Reset selezione impasto con il tipo originale
            // Il prezzo √® 0 per l'impasto originale della pizza
            selectedDough = {
                type: defaultDoughType,
                price: 0,
                originalType: defaultDoughType // Salva il tipo originale per calcoli futuri
            };
            
            document.getElementById('pizzaModalTitle').textContent = pizza.nome;
            document.getElementById('pizzaModalBasePrice').textContent = parseFloat(pizza.prezzo).toFixed(2);
            document.getElementById('pizzaModalExtraPrice').textContent = '0.00';
            document.getElementById('pizzaModalTotalPrice').textContent = parseFloat(pizza.prezzo).toFixed(2);
            document.getElementById('pizzaQuantity').value = 1;
            
            // Reset selezione impasto nel DOM
            resetDoughSelection();
            
            // Aggiorna la visualizzazione degli ingredienti con l'impasto selezionato
            updateIngredientsDisplay();
            
            // Aggiorna la visualizzazione dei prezzi degli impasti
            updateDoughPricesDisplay();
            
            // Nascondi la sezione impasti per le pizze senza glutine e per i dolci
            const doughSection = document.querySelector('.dough-section');
            const ingredientList = document.getElementById('ingredientList');
            const addIngredientsBtn = document.getElementById('showAdditionsBtn');
            
            if (pizza.categoria === 'PIZZA SENZA GLUTINE' || pizza.categoria === 'DOLCI') {
                doughSection.style.display = 'none';
            } else {
                doughSection.style.display = 'block';
            }
            
            // Nascondi la lista ingredienti e il pulsante aggiungi ingredienti per i dolci
            if (pizza.categoria === 'DOLCI') {
                ingredientList.style.display = 'none';
                addIngredientsBtn.style.display = 'none';
            } else {
                ingredientList.style.display = 'block';
                addIngredientsBtn.style.display = 'block';
            }
            
            // Imposta immagine se presente nel CSV
            const imgEl = document.getElementById('pizzaModalImage');
            if (pizza.immagine) {
                imgEl.src = pizza.immagine;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }
            
            // Mostra allergeni della pizza
            const allergens = pizza.allergeni ? pizza.allergeni.split(',').map(a => parseInt(a.trim())).filter(a => !isNaN(a)) : [];
            const allergensEl = document.getElementById('pizzaAllergens');

            if (allergens.length > 0) {
                allergensEl.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Allergeni:</strong> ${allergens.sort((a, b) => a - b).join(', ')}
                    </div>
                `;
            } else {
                allergensEl.innerHTML = `
                    <div class="alert alert-success">
                        Questa pizza non contiene allergeni comuni
                    </div>
                `;
            }
            
            // Prepara la lista degli ingredienti modificabili
            renderIngredientList(pizza);
            
            new bootstrap.Modal(document.getElementById('pizzaModal')).show();
        }

        // Funzioni per gestire la selezione degli impasti
        function resetDoughSelection() {
            // Reset visual selection
            document.querySelectorAll('.dough-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Select the correct option based on selectedDough.type
            const correctOption = document.querySelector(`.dough-option[data-dough="${selectedDough.type}"]`);
            if (correctOption) {
                correctOption.classList.add('selected');
                correctOption.querySelector('input[type="radio"]').checked = true;
            }
        }

        function setupDoughEventListeners() {
            document.querySelectorAll('.dough-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selection from all options
                    document.querySelectorAll('.dough-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selection to clicked option
                    this.classList.add('selected');
                    
                    // Update radio button
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // Update selected dough data
                    const newDoughType = this.dataset.dough;
                    const newDoughPrice = parseFloat(this.dataset.price);
                    
                    // Calcola il prezzo: 0 se √® l'impasto originale, altrimenti il prezzo dell'impasto
                    let finalPrice = 0;
                    if (selectedDough.originalType !== newDoughType) {
                        finalPrice = newDoughPrice;
                    }
                    
                    selectedDough = {
                        type: newDoughType,
                        price: finalPrice,
                        originalType: selectedDough.originalType // Mantieni il tipo originale
                    };
                    
                    // Update ingredients display with new dough
                    updateIngredientsDisplay();
                    
                    // Update total price
                    updatePizzaPrice();
                });
            });
        }

        // Aggiorna la visualizzazione degli ingredienti base con l'impasto selezionato
        function updateIngredientsDisplay() {
            if (!currentPizza) return;
            
            // Ottieni gli ingredienti originali
            const originalIngredients = currentPizza.ingredienti.split(',').map(i => i.trim());
            
            // Trova l'impasto originale
            const originalDoughIndex = originalIngredients.findIndex(ingredient => 
                ingredient.toLowerCase().startsWith('impasto')
            );
            
            // Crea la nuova lista di ingredienti
            let updatedIngredients = [...originalIngredients];
            
            // Mappa dei tipi di impasto
            const doughTypeMap = {
                'normale': 'impasto classico',
                'proteico': 'impasto proteico', 
                'carbone': 'impasto al carbone',
                'tirato': 'impasto tirato'
            };
            
            // Sostituisci l'impasto se trovato
            if (originalDoughIndex !== -1) {
                updatedIngredients[originalDoughIndex] = doughTypeMap[selectedDough.type] || 'impasto classico';
            } else {
                // Se non c'√® un impasto negli ingredienti, aggiungilo all'inizio
                updatedIngredients.unshift(doughTypeMap[selectedDough.type] || 'impasto classico');
            }
            
            // Aggiorna la visualizzazione
            document.getElementById('pizzaModalBaseIngredients').textContent = updatedIngredients.join(', ');
        }

        // Aggiorna la visualizzazione dei prezzi degli impasti
        function updateDoughPricesDisplay() {
            if (!selectedDough.originalType) return;
            
            // Mappa dei prezzi degli impasti
            const doughPrices = {
                'normale': 0,
                'proteico': 2.00,
                'carbone': 2.00,
                'tirato': 2.00
            };
            
            // Aggiorna ogni opzione di impasto
            document.querySelectorAll('.dough-option').forEach(option => {
                const doughType = option.dataset.dough;
                const priceElement = option.querySelector('.dough-price');
                
                if (doughType === selectedDough.originalType) {
                    // Impasto originale - mostra "Incluso"
                    priceElement.textContent = 'Incluso';
                    priceElement.classList.remove('extra');
                } else {
                    // Altri impasti - mostra il prezzo
                    const price = doughPrices[doughType] || 0;
                    priceElement.textContent = `+${price.toFixed(2)}‚Ç¨`;
                    priceElement.classList.add('extra');
                }
            });
        }

        // Renderizza la lista degli ingredienti modificabili
        function renderIngredientList(pizza) {
            ingredientListEl.innerHTML = '';
            
            // Aggiungi titolo sezione
            const title = document.createElement('h6');
            title.className = 'mt-3';
            title.textContent = 'Personalizza ingredienti:';
            ingredientListEl.appendChild(title);
            
            // Ingredienti base della pizza (esclusi gli impasti)
            const baseIngredients = pizza.ingredienti.split(',')
                .map(i => i.trim())
                .filter(ingredient => !ingredient.toLowerCase().startsWith('impasto'));
            
            // Per ogni ingrediente base, crea un elemento con pulsante rimozione
            baseIngredients.forEach(ingredient => {
                const ingredientItem = document.createElement('div');
                ingredientItem.className = 'ingredient-item';
                
                const isRemoved = currentModifications.removed.includes(ingredient);
                
                ingredientItem.innerHTML = `
                    <span class="${isRemoved ? 'removed-ingredient' : ''}">${ingredient}</span>
                    <div class="ingredient-actions">
                        <button class="btn btn-sm ${isRemoved ? 'btn-success' : 'btn-outline-danger'} toggle-ingredient" data-ingredient="${ingredient}" data-action="${isRemoved ? 'add' : 'remove'}">
                            ${isRemoved ? 'Aggiungi' : 'Rimuovi'}
                        </button>
                    </div>
                `;
                
                ingredientListEl.appendChild(ingredientItem);
            });
            
            // Mostra ingredienti aggiunti se presenti
            if (currentModifications.added.length > 0) {
                const addedTitle = document.createElement('h6');
                addedTitle.className = 'mt-3';
                addedTitle.textContent = 'Ingredienti aggiunti:';
                ingredientListEl.appendChild(addedTitle);
                
                currentModifications.added.forEach(added => {
                    const addedItem = document.createElement('div');
                    addedItem.className = 'ingredient-item added-ingredient';
                    
                    addedItem.innerHTML = `
                        <span>${added.ingredient} (+${added.price.toFixed(2)}‚Ç¨)</span>
                        <div class="ingredient-actions">
                            <button class="btn btn-sm btn-outline-danger remove-added" data-ingredient="${added.ingredient}">
                                Rimuovi
                            </button>
                        </div>
                    `;
                    
                    ingredientListEl.appendChild(addedItem);
                });
            }
            
            // Aggiungi event listeners
            document.querySelectorAll('.toggle-ingredient').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ingredient = this.getAttribute('data-ingredient');
                    const action = this.getAttribute('data-action');
                    
                    if (action === 'remove') {
                        removeIngredient(ingredient);
                    } else {
                        addBaseIngredient(ingredient);
                    }
                });
            });
            
            document.querySelectorAll('.remove-added').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ingredient = this.getAttribute('data-ingredient');
                    removeAddedIngredient(ingredient);
                });
            });
            
            // Aggiorna il pulsante per mostrare le aggiunte
            showAdditionsBtn.onclick = () => showAdditionsModal(pizza);
        }

        // Mostra il modal per aggiungere ingredienti
        function showAdditionsModal(pizza) {
            additionsListEl.innerHTML = '';
            selectedAdditions = [...currentModifications.added];
            
            // Filtra gli ingredienti gi√† presenti nella pizza o gi√† aggiunti
            const baseIngredients = pizza.ingredienti.split(',').map(i => i.trim());
            // Se la pizza √® la BASE (SG), consenti solo ingredienti usable
            const isGlutenFreeBase = (typeof pizza.nome === 'string') && (pizza.nome.trim().toLowerCase() === 'base');
            const availableAdditions = (window.__allAdditions || [])
                .filter(a => !baseIngredients.includes(a.ingredient))
                .filter(a => !isGlutenFreeBase || a.usable === true);
            
            availableAdditions.forEach(add => {
                const ingredient = add.ingredient;
                const price = add.price || 0;
                const isSelected = selectedAdditions.some(a => a.ingredient === ingredient);
                
                const item = document.createElement('div');
                item.className = 'addition-item';
                
                item.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               id="add-${ingredient.replace(/[^a-zA-Z0-9_-]/g, '')}" 
                               value="${ingredient}" 
                               ${isSelected ? 'checked' : ''}
                               data-price="${price}">
                        <label class="form-check-label" for="add-${ingredient.replace(/[^a-zA-Z0-9_-]/g, '')}">
                            ${ingredient} (+${price.toFixed(2)}‚Ç¨)
                        </label>
                    </div>
                `;
                
                additionsListEl.appendChild(item);
            });
            
            // Aggiungi event listener per i checkbox
            additionsListEl.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const ingredient = this.value;
                    const price = parseFloat(this.getAttribute('data-price'));
                    
                    if (this.checked) {
                        selectedAdditions.push({ ingredient, price });
                    } else {
                        selectedAdditions = selectedAdditions.filter(a => a.ingredient !== ingredient);
                    }
                });
            });
            
            // Mostra il modal
            new bootstrap.Modal(document.getElementById('additionsModal')).show();
        }

        // Rimuovi ingrediente base
        function removeIngredient(ingredient) {
            if (!currentModifications.removed.includes(ingredient)) {
                currentModifications.removed.push(ingredient);
                updatePizzaPrice();
                renderIngredientList(currentPizza);
            }
        }

        // Aggiungi ingrediente base (precedentemente rimosso)
        function addBaseIngredient(ingredient) {
            currentModifications.removed = currentModifications.removed.filter(i => i !== ingredient);
            updatePizzaPrice();
            renderIngredientList(currentPizza);
        }

        // Conferma aggiunte selezionate
        confirmAdditionsBtn.onclick = () => {
            const isGlutenFreeBase = (typeof currentPizza.nome === 'string') && (currentPizza.nome.trim().toLowerCase() === 'base');
            let additions = [...selectedAdditions];
            if (isGlutenFreeBase) {
                const dbAdds = window.__allAdditions || [];
                additions = additions.filter(a => dbAdds.some(dbA => dbA.ingredient === a.ingredient && dbA.usable === true));
            }
            currentModifications.added = additions;
            updatePizzaPrice();
            renderIngredientList(currentPizza);
            bootstrap.Modal.getInstance(document.getElementById('additionsModal')).hide();
        };

        // Rimuovi ingrediente aggiunto
        function removeAddedIngredient(ingredient) {
            currentModifications.added = currentModifications.added.filter(i => i.ingredient !== ingredient);
            updatePizzaPrice();
            renderIngredientList(currentPizza);
        }

        // Aggiorna prezzo totale nel modal
        function updatePizzaPrice() {
            const basePrice = parseFloat(currentPizza.prezzo);
            let extraPrice = 0;
            
            // Calcola costo ingredienti aggiunti
            currentModifications.added.forEach(ing => {
                extraPrice += ing.price;
            });
            
            // Aggiungi costo impasto
            extraPrice += selectedDough.price;

            // Sincronizza con il DB: evita ingredienti non pi√π presenti (opzionale)
            if (window.__allAdditions) {
                currentModifications.added = currentModifications.added.filter(a => 
                    window.__allAdditions.some(dbA => dbA.ingredient === a.ingredient)
                );
            }
            
            document.getElementById('pizzaModalExtraPrice').textContent = extraPrice.toFixed(2);
            document.getElementById('pizzaModalTotalPrice').textContent = (basePrice + extraPrice).toFixed(2);
        }

        // Aggiungi bevanda al carrello (senza personalizzazioni)
        function addBeverageToCart(beverage) {
            const basePrice = parseFloat(beverage.prezzo);
            
            // Cerca se la bevanda √® gi√† nel carrello
            const existingItemIndex = cart.findIndex(item => 
                item.id === beverage.id && item.isBeverage === true
            );
            
            if (existingItemIndex >= 0) {
                // Bevanda gi√† nel carrello, aumenta quantit√†
                cart[existingItemIndex].quantity += 1;
                cart[existingItemIndex].total = cart[existingItemIndex].quantity * basePrice;
            } else {
                // Nuova bevanda nel carrello
                cart.push({
                    id: beverage.id,
                    name: beverage.nome,
                    basePrice: basePrice,
                    extraPrice: 0,
                    quantity: 1,
                    total: basePrice,
                    isBeverage: true,
                    category: (beverage.categoria || 'Birre/Bibite'),
                    categoria: (beverage.categoria || 'Birre/Bibite'),
                    description: beverage.descrizione || beverage.ingredienti || '',
                    removed: [],
                    added: [],
                    dough: { type: 'normale', price: 0 }
                });
            }
            
            updateCartUI();
            
            // Mostra notifica
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
                z-index: 9999;
                font-weight: 600;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = `<i class="bi bi-check-circle"></i> ${beverage.nome} aggiunta al carrello!`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Aggiungi al carrello
        function addToCart() {
            const quantity = parseInt(document.getElementById('pizzaQuantity').value) || 1;
            const basePrice = parseFloat(currentPizza.prezzo);
            let extraPrice = 0;
            
            // Calcola costo ingredienti aggiunti
            currentModifications.added.forEach(ing => {
                extraPrice += ing.price;
            });
            
            // Aggiungi costo impasto
            extraPrice += selectedDough.price;
            
            const totalPrice = basePrice + extraPrice;
            
            const existingItemIndex = cart.findIndex(item => 
                item.id === currentPizza.id && 
                JSON.stringify(item.removed) === JSON.stringify(currentModifications.removed) &&
                JSON.stringify(item.added) === JSON.stringify(currentModifications.added) &&
                JSON.stringify(item.dough) === JSON.stringify(selectedDough)
            );
            
            if (existingItemIndex >= 0) {
                // Pizza con le stesse modifiche gi√† nel carrello, aumenta quantit√†
                cart[existingItemIndex].quantity += quantity;
                cart[existingItemIndex].total = cart[existingItemIndex].quantity * totalPrice;
            } else {
                // Nuova pizza nel carrello
                cart.push({
                    id: currentPizza.id,
                    name: currentPizza.nome,
                    basePrice: basePrice,
                    extraPrice: extraPrice,
                    quantity: quantity,
                    total: totalPrice * quantity,
                    baseIngredients: currentPizza.ingredienti,
                    removed: [...currentModifications.removed],
                    added: [...currentModifications.added],
                    dough: {...selectedDough}
                });
            }
            
            updateCartUI();
            bootstrap.Modal.getInstance(document.getElementById('pizzaModal')).hide();
            alert(`${quantity}x ${currentPizza.nome} personalizzata aggiunta al carrello!`);
        }

        // Aggiorna UI carrello
        function updateCartUI() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCounter.textContent = totalItems;
            cartItemsEl.innerHTML = '';
            
            if (cart.length === 0) {
                cartItemsEl.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-cart-x" style="font-size: 2rem;"></i><p class="mt-2">Il tuo carrello √® vuoto</p></div>';
                cartTotalEl.textContent = '0.00';
                copertoCountEl.textContent = '0';
                copertoTotalEl.textContent = '0.00';
                totalWithCopertoEl.textContent = '0.00';
                checkOrderFields();
                return;
            }
            
            let grandTotal = 0;
            let totalPizzas = 0;
            
            cart.forEach((item, index) => {
                grandTotal += item.total;
                // Conta solo le pizze per il coperto, non le bevande
                if (!item.isBeverage) {
                    totalPizzas += item.quantity;
                }
                
                const itemEl = document.createElement('div');
                itemEl.className = 'cart-item';
                
                // Assicurati che l'item abbia la propriet√† dough (compatibilit√† con carrelli esistenti)
                if (!item.dough) {
                    item.dough = { type: 'normale', price: 0 };
                }
                
                // Mostra modifiche agli ingredienti e impasto (solo per pizze, non per bevande)
                let modificationsHtml = '';
                const isBeverage = item.isBeverage === true;
                
                if (!isBeverage) {
                    const hasModifications = item.removed.length > 0 || item.added.length > 0 || (item.dough && item.dough.type !== 'normale');
                    
                    if (hasModifications) {
                        modificationsHtml = '<div class="mt-2"><small class="text-muted">';
                        
                        // Mostra impasto se diverso da normale
                        if (item.dough && item.dough.type !== 'normale') {
                            const doughNames = {
                                'proteico': 'Impasto Proteico',
                                'carbone': 'Impasto al Carbone',
                                'tirato': 'Impasto Tirato'
                            };
                            modificationsHtml += `<span class="text-primary"><i class="bi bi-circle"></i> ${doughNames[item.dough.type] || item.dough.type}</span>`;
                        }
                        
                        if (item.removed.length > 0) {
                            if (item.dough && item.dough.type !== 'normale') modificationsHtml += '<br>';
                            const removedList = item.removed.map(r => `‚Ä¢ ${r}`).join('<br>');
                            modificationsHtml += `<span class="text-danger" style="font-size: 0.75rem;">Rimossi:<br>${removedList}</span>`;
                        }
                        
                        if (item.added.length > 0) {
                            if (item.removed.length > 0 || (item.dough && item.dough.type !== 'normale')) modificationsHtml += '<br>';
                            const addedList = item.added.map(a => `‚Ä¢ ${a.ingredient}`).join('<br>');
                            modificationsHtml += `<span class="text-success" style="font-size: 0.75rem;">Aggiunti:<br>${addedList}</span>`;
                        }
                        
                        modificationsHtml += '</small></div>';
                    }
                } else {
                    // Per le bevande, mostra la descrizione se presente
                    if (item.description) {
                        modificationsHtml = `<div class="mt-1"><small class="text-muted fst-italic">${item.description}</small></div>`;
                    }
                }
                
                itemEl.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">${isBeverage ? '<i class="bi bi-cup-straw"></i> ' : ''}${item.name}</h6>
                            <small class="text-muted">${item.quantity}x ${(item.basePrice + item.extraPrice).toFixed(2)}‚Ç¨</small>
                            ${modificationsHtml}
                        </div>
                        <div class="text-end">
                            <strong>${item.total.toFixed(2)}‚Ç¨</strong>
                            <button class="btn btn-sm btn-outline-danger ms-2 remove-item" data-index="${index}">‚úï</button>
                        </div>
                    </div>
                `;
                cartItemsEl.appendChild(itemEl);
            });
            
            // Calcola coperto (2‚Ç¨ per pizza)
            const coperto = 2 * totalPizzas;
            const totalWithCoperto = grandTotal + coperto;
            
            cartTotalEl.textContent = grandTotal.toFixed(2);
            copertoCountEl.textContent = totalPizzas;
            copertoTotalEl.textContent = coperto.toFixed(2);
            totalWithCopertoEl.textContent = totalWithCoperto.toFixed(2);
            
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    cart.splice(parseInt(this.getAttribute('data-index')), 1);
                    updateCartUI();
                });
            });
            
            checkOrderFields();
        }

        // Salva ordine su Firebase
        async function saveOrderToFirebase(orderData) {
            try {
                showFirebaseStatus('Salvataggio ordine in corso...', 'loading');
                
                // Aggiungi timestamp all'ordine
                orderData.timestamp = firebase.firestore.FieldValue.serverTimestamp();
                
                // Salva l'ordine nella collezione "orders"
                const docRef = await db.collection("orders").add(orderData);
                const docRef1 = await db.collection("orders").add(orderData);
                
                showFirebaseStatus('Ordine salvato con successo! ID: ' + docRef.id, 'success');
                showFirebaseStatus('Ordine salvato con successo! ID: ' + docRef1.id, 'success');
                return true;
            } catch (error) {
                console.error("Errore nel salvataggio su Firebase:", error);
                showFirebaseStatus('Errore nel salvataggio: ' + error.message, 'error');
                return false;
            }
        }

        // Conferma ordine
        async function checkout() {
            const orderName = orderNameInput.value.trim();
            const waiterNumber = waiterNumberInput.value.trim();
            
            if (!orderName || !waiterNumber) {
                alert('Compila tutti i campi obbligatori!');
                return;
            }
            
            if (cart.length === 0) {
                alert('Il carrello √® vuoto!');
                return;
            }
            
            // Prepara SOLO i dati essenziali per Firebase
            const normalizedCart = cart.map((item, index) => ({
                ...item,
                category: (item.category || item.categoria || "").toLowerCase(),
                __originalIndex: index
            }));

            const isBeverageItem = (item) => {
                if (item.isBeverage === true) return true;
                if (item.isBeverage === false) return false;
                if (typeof item.isBeverage === 'string') {
                    const normalised = item.isBeverage.trim().toLowerCase();
                    if (normalised === 'true') return true;
                    if (normalised === 'false') return false;
                }
                return item.category === 'birre/bibite';
            };

            normalizedCart.forEach(item => {
                if (!item.category) {
                    item.category = isBeverageItem(item) ? 'birre/bibite' : 'pizze';
                }
            });

            const getOrderPriority = (item) => {
                if (item.category === 'stuzzichini') return 0; // stuzzichini vengono prima
                if (isBeverageItem(item) || item.category === 'birre/bibite') return 2; // bevande vengono ultime
                return 1; // pizze vengono nel mezzo
            };

            const sortedCartForFirebase = [...normalizedCart].sort((a, b) => {
                const priorityDiff = getOrderPriority(a) - getOrderPriority(b);
                if (priorityDiff !== 0) return priorityDiff;
                return a.__originalIndex - b.__originalIndex;
            });

            const pizzeOrdinate = sortedCartForFirebase.map(item => {
                const isBeverage = isBeverageItem(item) || item.category === 'birre/bibite';
                let nomeCompleto = item.name;

                if (!isBeverage) {
                    // Aggiungi impasto se diverso da normale
                    if (item.dough && item.dough.type !== 'normale') {
                        const doughNames = {
                            'proteico': 'Impasto Proteico',
                            'carbone': 'Impasto al Carbone',
                            'tirato': 'Impasto Tirato'
                        };
                        nomeCompleto += ` - ${doughNames[item.dough.type] || item.dough.type}`;
                    }

                    // Aggiungi modifiche al nome se presenti
                    if (item.removed.length > 0 || item.added.length > 0) {
                        let modifiche = [];
                        if (item.removed.length > 0) {
                            modifiche.push(`SENZA: ${item.removed.join(', ')}`);
                        }
                        if (item.added.length > 0) {
                            // Estrai solo i nomi degli ingredienti dagli oggetti
                            const nomiIngredienti = item.added.map(a => a.ingredient || a);
                            modifiche.push(`CON: ${nomiIngredienti.join(', ')}`);
                        }
                        nomeCompleto += ` (${modifiche.join(' - ')})`;
                    }
                }

                return {
                    pizza: nomeCompleto,
                    quantita: item.quantity
                };
            });
            
            const orderData = {
                tavolo: orderName,
                cameriere: waiterNumber,
                status: "Nuovo",
                pizze: pizzeOrdinate
            };
            
            // Salva su Firebase
            const success = await saveOrderToFirebase(orderData);
            
            if (success) {
                // Resetta il carrello solo se il salvataggio √® riuscito
                cart = [];
                orderNameInput.value = '';
                waiterNumberInput.value = '';
                
                // Resetta la selezione delle carte
                selectedSuit = null;
                selectedNumber = null;
                document.querySelectorAll('.suit-btn').forEach(btn => btn.classList.remove('selected'));
                document.querySelectorAll('.number-btn').forEach(btn => {
                    btn.classList.remove('selected');
                    btn.classList.add('disabled');
                });
                const selectedCardDisplay = document.getElementById('selectedCardDisplay');
                selectedCardDisplay.textContent = 'Seleziona prima il seme, poi il numero';
                selectedCardDisplay.classList.add('empty');
                
                updateCartUI();
                
                // Non chiudere automaticamente l'offcanvas per mostrare il messaggio di successo
            } else {
                alert("Si √® verificato an errore durante il salvataggio dell'ordine. Riprova.");
            }
        }

        // Filtri
        function showAllCategories() {
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent === 'Tutte');
            });
            document.querySelectorAll('.category-section').forEach(section => {
                section.style.display = 'block';
            });
        }

        function filterByCategory(category) {
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent === category);
            });
            document.querySelectorAll('.category-section').forEach(section => {
                section.style.display = section.id === `cat-${category.replace(/\s+/g, '-')}` ? 'block' : 'none';
            });
        }

        // Aggiorna la lista degli allergeni selezionati
        function updateSelectedAllergensList() {
            if (userAllergens.length === 0) {
                selectedAllergensList.innerHTML = 'Nessun allergene selezionato';
                return;
            }
            
            selectedAllergensList.innerHTML = userAllergens
                .sort((a, b) => a - b)
                .map(a => `<span class="badge bg-danger me-1">${a}</span>`)
                .join(' ');
        }

        // Evidenzia le pizze che contengono allergeni selezionati
        function highlightPizzasWithAllergens() {
            const pizzaCards = document.querySelectorAll('.pizza-card');

            pizzaCards.forEach(card => {
                card.classList.remove('allergen-warning');

                const itemName = card.getAttribute('data-item-name');
                const item = window.menuItems.find(p => p.nome === itemName);

                if (!item) return;

                // Parse allergens from CSV data
                const allergens = item.allergeni ? item.allergeni.split(',').map(a => parseInt(a.trim())).filter(a => !isNaN(a)) : [];

                // Controlla se l'item contiene allergeni selezionati
                const hasAllergen = userAllergens.some(allergen =>
                    allergens.includes(allergen)
                );

                if (hasAllergen) {
                    card.classList.add('allergen-warning');
                }
            });
        }

        // Setup selettore carte da briscola
        function setupCardSelector() {
            const suitButtons = document.querySelectorAll('.suit-btn');
            const numberButtons = document.querySelectorAll('.number-btn');
            const selectedCardDisplay = document.getElementById('selectedCardDisplay');
            
            // Gestione selezione seme
            suitButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Rimuovi selezione precedente
                    suitButtons.forEach(b => b.classList.remove('selected'));
                    
                    // Seleziona il nuovo seme
                    this.classList.add('selected');
                    selectedSuit = this.getAttribute('data-suit');
                    
                    // Abilita i numeri
                    numberButtons.forEach(nb => {
                        nb.classList.remove('disabled');
                    });
                    
                    // Aggiorna il display
                    updateCardDisplay();
                });
            });
            
            // Gestione selezione numero
            numberButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    
                    // Rimuovi selezione precedente
                    numberButtons.forEach(b => b.classList.remove('selected'));
                    
                    // Seleziona il nuovo numero
                    this.classList.add('selected');
                    selectedNumber = this.getAttribute('data-number');
                    
                    // Aggiorna il display
                    updateCardDisplay();
                });
            });
        }
        
        // Aggiorna il display della carta selezionata
        function updateCardDisplay() {
            const selectedCardDisplay = document.getElementById('selectedCardDisplay');
            const orderNameInput = document.getElementById('orderName');
            
            if (selectedSuit && selectedNumber) {
                const cardValue = `${suitIcons[selectedSuit]} ${suitNames[selectedSuit]} ${selectedNumber}`;
                selectedCardDisplay.textContent = cardValue;
                selectedCardDisplay.classList.remove('empty');
                
                // Aggiorna il campo nascosto con il valore alfanumerico
                orderNameInput.value = `${suitNames[selectedSuit]}-${selectedNumber}`;
                
                // Controlla se i campi sono compilati per abilitare il pulsante
                checkOrderFields();
            } else if (selectedSuit) {
                selectedCardDisplay.textContent = `${suitIcons[selectedSuit]} ${suitNames[selectedSuit]} - Seleziona il numero`;
                selectedCardDisplay.classList.add('empty');
                orderNameInput.value = '';
            } else {
                selectedCardDisplay.textContent = 'Seleziona prima il seme, poi il numero';
                selectedCardDisplay.classList.add('empty');
                orderNameInput.value = '';
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadMenuFromCSV();
            updateCartUI();
            
            // Setup event listeners per gli impasti
            setupDoughEventListeners();
            
            // Setup per i pulsanti allergeni
            document.querySelectorAll('.allergen-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    const allergen = parseInt(this.getAttribute('data-allergen'));
                    
                    if (this.classList.contains('selected')) {
                        if (!userAllergens.includes(allergen)) {
                            userAllergens.push(allergen);
                        }
                    } else {
                        userAllergens = userAllergens.filter(a => a !== allergen);
                    }
                    
                    updateSelectedAllergensList();
                });
            });
            
            // Applica la selezione allergeni
            applyAllergensBtn.addEventListener('click', function() {
                highlightPizzasWithAllergens();
                bootstrap.Modal.getInstance(document.getElementById('allergensModal')).hide();
            });
            
            // Cancella la selezione allergeni
            clearAllergensBtn.addEventListener('click', function() {
                userAllergens = [];
                document.querySelectorAll('.allergen-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                updateSelectedAllergensList();
                highlightPizzasWithAllergens();
            });
            
            // Setup selettore carte da briscola
            setupCardSelector();
        });

        // Event listeners
        addToCartBtn.addEventListener('click', addToCart);
        checkoutBtn.addEventListener('click', checkout);
    </script>
</body>
</html>


